"use strict";(self.webpackChunkwelfie_docs=self.webpackChunkwelfie_docs||[]).push([[125],{2256:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var r=t(4848),o=t(8453);const i={},s="Authentication",a={id:"mobile/auth",title:"Authentication",description:"This page covers how the mobile application is using Welfie's user authencation service.",source:"@site/docs/mobile/auth.md",sourceDirName:"mobile",slug:"/mobile/auth",permalink:"/docs/mobile/auth",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/mobile/auth.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Introduction",permalink:"/docs/mobile/intro"},next:{title:"intro",permalink:"/docs/website/intro"}},c={},l=[{value:"Signing In",id:"signing-in",level:2},{value:"Signing Out",id:"signing-out",level:2},{value:"Auth Context",id:"auth-context",level:2},{value:"Using it inside a React component",id:"using-it-inside-a-react-component",level:3}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"authentication",children:"Authentication"}),"\n",(0,r.jsxs)(n.p,{children:["This page covers how the mobile application is using Welfie's ",(0,r.jsx)(n.strong,{children:"user authencation"})," service."]}),"\n",(0,r.jsx)(n.p,{children:"The app is using the following features,"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Log in functionality"}),"\n",(0,r.jsx)(n.li,{children:"Log out functionality"}),"\n",(0,r.jsx)(n.li,{children:"React context to pass authentication data"}),"\n"]}),"\n",(0,r.jsx)("hr",{}),"\n",(0,r.jsxs)(n.p,{children:["The mobile application is using ",(0,r.jsx)(n.a,{href:"https://axios-http.com/",children:"Axios"})," to handle HTTP requests. It is recommended to use something like ",(0,r.jsx)(n.a,{href:"https://postman.com/",children:"Postman"})," to test your api calls before running them directly from code."]}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.p,{children:["The API routes covered in this documentation are derived from Welfie's ",(0,r.jsx)(n.a,{href:"https://bitbucket.org/welfietech/tenant-repo/src/master/welfie-web/src/controller/auth-controller.ts",children:"auth routes"})]})}),"\n",(0,r.jsx)(n.h2,{id:"signing-in",children:"Signing In"}),"\n",(0,r.jsx)(n.p,{children:"There are a few steps behind signing into Welfie's platform."}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"You must generate a JWT token using a email and password."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="./context/auth-context.tsx"',children:'import axios from "axios";\r\n\r\n//... Other code\r\n\r\nconst generatedJWT = await axios.post(`${AppConfig.apiURL}/auth/loginToken`, {\r\n  email,\r\n  password,\r\n});\n'})}),"\n",(0,r.jsx)(n.p,{children:"You will recieve the following payload,"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"{\r\n  loginToken: string;\r\n}\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"Do not publicly share or spread the token as it contains sensitive information about the user. In addition, JWT tokens should not be used on the client side without encryption."})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"Once you have the token, you can use it to log into the platform. The body requires loginToken as the key."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="./context/auth-context.tsx"',children:'const response = await axios.post(`${AppConfig.apiURL}/auth/login`, {\r\n  loginToken: generatedJWT.data.loginToken,\r\n});\r\nconst user = response.data;\r\nconsole.log("Attempted authentication result:", user);\n'})}),"\n",(0,r.jsx)(n.p,{children:"Afterwards you will receieve the following payload afterwards,"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"{\r\n  hasProfile: boolean;\r\n  isEmailVerified: boolean;\r\n  isInvited: boolean;\r\n  lastActivity: Date;\r\n  token: string;\r\n}\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsx)(n.p,{children:"We use an AppConfig for our API urls as the envrionment of the codebase can change."})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"Every API call involving data related to the user requires authentication using a bearer token. We use Axios' automatic header functionality to automatically set the bearer token with every API call."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="./context/auth-context.tsx"',children:'axios.defaults.headers.common["Authorization"] = `Bearer ${user.token}`;\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsx)(n.li,{children:"Finally, to save the user's login activity on multiple app visits, we save the token in an encrypted storage so that the user does not need to sign in again when re-opening the app."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="./context/auth-context.tsx"',children:'import * as SecureStore from "expo-secure-store";\r\n\r\n//... previous code\r\n\r\n// Store the authenticated user data in encrypted local storage\r\nawait SecureStore.setItemAsync("user", JSON.stringify(user));\n'})}),"\n",(0,r.jsx)(n.p,{children:"Here is the full code for signing in,"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="./context/auth-context.tsx"',children:'const login = async (\r\n  email: string,\r\n  password: string\r\n): Promise<{ error: any } | { success: string }> => {\r\n  if (loading) {\r\n    return { error: "Currently loading" };\r\n  }\r\n  setLoading(true);\r\n  try {\r\n    // Generate JWT token from backend\r\n    const generatedJWT = await axios.post(\r\n      `${AppConfig.apiURL}/auth/loginToken`,\r\n      { email, password }\r\n    );\r\n\r\n    console.log("Generated token:", generatedJWT.data.loginToken);\r\n\r\n    // Send login authentication request to backend. The body requires loginToken as the key\r\n    const response = await axios.post(`${AppConfig.apiURL}/auth/login`, {\r\n      loginToken: generatedJWT.data.loginToken,\r\n    });\r\n\r\n    const user: AuthenticatedUser = response.data;\r\n\r\n    console.log("Attempted authentication result:", user);\r\n\r\n    // Token retrieval indicates user is validated\r\n    setUser(user);\r\n    axios.defaults.headers.common["Authorization"] = `Bearer ${user.token}`;\r\n\r\n    console.log("Set http headers successfully");\r\n\r\n    // Store the authenticated user data in encrypted local storage\r\n    await SecureStore.setItemAsync("user", JSON.stringify(user));\r\n    console.log("Saved token into storage");\r\n    setLoading(false);\r\n    return { success: "Successfully logged in" };\r\n  } catch (error) {\r\n    setLoading(false);\r\n    return { error: (error as any).message || "Login failed" };\r\n  }\r\n};\n'})}),"\n",(0,r.jsx)(n.h2,{id:"signing-out",children:"Signing Out"}),"\n",(0,r.jsx)(n.p,{children:"We do the opposite functionality of signing in,"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="./context/auth-context.tsx"',children:'const logout = async () => {\r\n  try {\r\n    //highlight-start\r\n    // Send a logout notice to the backend\r\n    axios.post(`${AppConfig.apiURL}/auth/logout`, {});\r\n\r\n    // Delete existing token from storage\r\n    await SecureStore.deleteItemAsync("user");\r\n\r\n    // Update HTTP headers\r\n    axios.defaults.headers.common["Authorization"] = "";\r\n    //highlight-end\r\n\r\n    console.log("User logged out.");\r\n\r\n    return { success: "Successfully logged out" };\r\n  } catch (error) {\r\n    setLoading(false);\r\n    return { error: (error as any).message || "Logout failed" };\r\n  }\r\n};\n'})}),"\n",(0,r.jsx)(n.h2,{id:"auth-context",children:"Auth Context"}),"\n",(0,r.jsx)(n.p,{children:"The application is using React's context to provide the authenticated user to the rest of the application."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",metastring:'title="./app/_layout.tsx"',children:'import { Stack } from "expo-router";\r\nimport AuthProvider from "@/context/auth-context";\r\nimport React from "react";\r\n\r\nexport default function RootLayout() {\r\n  return (\r\n    //highlight-next-line\r\n    <AuthProvider>\r\n      <ThemeProvider value={DefaultTheme}>\r\n        <Stack>{/* Screens */}</Stack>\r\n      </ThemeProvider>\r\n      //highlight-next-line\r\n    </AuthProvider>\r\n  );\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"We created a context provider that contains the authentication logic from the previous sections,"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",metastring:'title="./context/auth-context.tsx"',children:'import React, { createContext, useEffect, useState } from "react";\r\nimport * as SecureStore from "expo-secure-store";\r\nimport AppConfig from "@/constants/app-config";\r\nimport axios from "axios";\r\nimport { AuthenticatedUser, AuthProps } from "@/types/auth";\r\n\r\n// Create a context hook so that you can extract authenticated user in other components and hooks\r\n//highlight-next-line\r\nexport const AuthContext = createContext<AuthProps | undefined>(undefined);\r\n\r\nconst AuthProvider = ({ children }: { children: React.ReactNode }) => {\r\n  const [isLogged, setIsLogged] = useState(false);\r\n  const [user, setUser] = useState<AuthenticatedUser | null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  useEffect(() => {\r\n    // At the start of the application, immediately check if there is an existing user if they logged in before\r\n    const loadToken = async () => {\r\n      const userJSON = await SecureStore.getItemAsync("user");\r\n\r\n      if (userJSON) {\r\n        const user: AuthenticatedUser = JSON.parse(userJSON);\r\n        axios.defaults.headers.common["Authorization"] = `Bearer ${user.token}`;\r\n        setUser(user);\r\n        setIsLogged(true);\r\n      } else {\r\n        setUser(null);\r\n        setIsLogged(false);\r\n      }\r\n    };\r\n    loadToken();\r\n  }, []);\r\n\r\n  const login = async (\r\n    email: string,\r\n    password: string\r\n  ): Promise<{ error: any } | { success: string }> => {\r\n    // Login logic from previous section\r\n  };\r\n\r\n  const logout = async () => {\r\n    // Logout logic from previous section\r\n  };\r\n\r\n  const value: AuthProps = {\r\n    authenticated: isLogged,\r\n    currentUser: user,\r\n    loading,\r\n    login,\r\n    logout,\r\n  };\r\n\r\n  // Return the context provider along with the React children\r\n  //highlight-next-line\r\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\r\n};\r\n\r\nexport default AuthProvider;\n'})}),"\n",(0,r.jsx)(n.h3,{id:"using-it-inside-a-react-component",children:"Using it inside a React component"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:'const Welcome = () => {\r\n  // Extract the authenticated status from auth context\r\n  //highlight-next-line\r\n  const { loading, authenticated } = useAuth();\r\n  if (!loading && authenticated) return <Redirect href="/home" />;\r\n\r\n  return -(\r\n    <View>\r\n      <Text> You are not logged in yet! </Text>-{" "}\r\n    </View>\r\n  );\r\n};\r\n\r\nexport default Welcome;\n'})})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var r=t(6540);const o={},i=r.createContext(o);function s(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);